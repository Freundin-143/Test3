@page "/TransacHis"
@using Test3.Data.Models
@using Test3.Data.Services
@inject TransactionService TransactionService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<div class="dashboard-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">
            <img src="images/Default_Landlord.png" alt="Logo">
            <h2>DASHBOARD</h2>
        </div>

        <nav>
            <button class="nav-btn manage-apartment" @onclick="ManageApartment">Manage Apartment</button>
            <button class="nav-btn list-tenants" @onclick="ListofTenants">List of Tenants</button>
            <button class="nav-btn transaction-history" @onclick="TransacHistory">Transaction History</button>
        </nav>

        <div class="bottom-section">
            <button class="logout-btn" @onclick="Logout">
                Log out
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header-section">
            <h2>Transaction History</h2>
            <div class="summary-cards">
                <div class="summary-card">
                    <h3>Total Revenue</h3>
                    <p class="amount">₱@TotalRevenue.ToString("N2")</p>
                </div>
                <div class="summary-card">
                    <h3>This Month</h3>
                    <p class="amount">₱@ThisMonthRevenue.ToString("N2")</p>
                </div>
                <div class="summary-card">
                    <h3>Total Transactions</h3>
                    <p class="count">@Transactions.Count</p>
                </div>
            </div>
        </div>

        <div class="table-container">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Name of Tenant</th>
                        <th>Unit#</th>
                        <th>Amount</th>
                        <th>Payment Method</th>
                        <th>Date</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    @if (!Transactions.Any())
                    {
                        <tr>
                            <td colspan="7" class="text-center no-data">No transactions found.</td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var transaction in Transactions.Select((value, index) => new { value, index }))
                        {
                            <tr>
                                <td>@(transaction.index + 1)</td>
                                <td>@transaction.value.FullName</td>
                                <td>@transaction.value.UnitNumber</td>
                                <td>₱@transaction.value.PaymentAmount.ToString("N2")</td>
                                <td>@transaction.value.PaymentMethod</td>
                                <td>@transaction.value.PaymentDate.ToString("MMM dd, yyyy")</td>
                                <td>
                                    <span class="status-badge @transaction.value.Status.ToLower()">
                                        @transaction.value.Status
                                    </span>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "landlordId")]
    public string? LandlordId { get; set; }

    private List<TransactionHistory> Transactions = new();
    private decimal TotalRevenue = 0;
    private decimal ThisMonthRevenue = 0;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrEmpty(LandlordId))
        {
            // Handle error - redirect to login
            return;
        }

        await LoadTransactions();
    }

    private async Task LoadTransactions()
    {
        try
        {
            Transactions = await TransactionService.GetTransactionsByLandlordAsync(LandlordId);

            // Calculate totals
            TotalRevenue = Transactions.Sum(t => t.PaymentAmount);

            var currentMonth = DateTime.Now.Month;
            var currentYear = DateTime.Now.Year;
            ThisMonthRevenue = Transactions
                .Where(t => t.PaymentDate.Month == currentMonth && t.PaymentDate.Year == currentYear)
                .Sum(t => t.PaymentAmount);

            isLoading = false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading transactions: {ex.Message}");
            isLoading = false;
        }
    }

    private void Logout()
    {
        Navigation.NavigateTo("/Landlord", true);
    }

    private void ManageApartment()
    {
        Navigation.NavigateTo($"/ManageApartment?landlordId={LandlordId}", true);
    }

    private void ListofTenants()
    {
        Navigation.NavigateTo($"/ListTenants?landlordId={LandlordId}", true);
    }

    private void TransacHistory()
    {
        Navigation.NavigateTo($"/TransacHis?landlordId={LandlordId}", true);
    }
}