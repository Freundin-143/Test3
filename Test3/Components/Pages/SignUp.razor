@page "/SignUp"
@rendermode InteractiveServer
@inject NavigationManager Navigation
@inject UserService UserService
@using Microsoft.AspNetCore.Components.Forms
@using Test3.Data.Models
@using Test3.Data.Services
@using System.Text.RegularExpressions
@inject IJSRuntime JSRuntime

<div class="profile-container">
    <header class="profile-header">
        <button class="back-btn" @onclick="NavigateToLogin"> Back </button>

        <div class="photo-section">
            <h2 class="section-title">Tenant's Personal Information</h2>
            <div class="photo-placeholder">
                @if (imageUrl != null)
                {
                    <img src="@imageUrl" alt="User Photo"
                         style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;" />
                }
                else
                {
                    <img src="images/Default_Landlord.png" alt="Default User"
                         style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;" />
                }
            </div>

            <div class="file-input-wrapper">
                <label class="custom-file-input">
                    <InputFile OnChange="HandleFileSelected"
                               accept=".png,.jpg,.jpeg"
                               class="hidden-file-input" />
                </label>
            </div>
        </div>
    </header>

    <div class="info-section">
        <div class="info-column">
            <label>First Name:</label>
            <input @bind="user.FirstName" />

            <label>Middle Name:</label>
            <input @bind="user.MiddleName" />

            <label>Last Name:</label>
            <input @bind="user.LastName" />

            <label>Gender:</label>
            <div class="select-wrapper">
                <select @bind="user.Gender">
                    <option value="">Select Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <label>Contact Number:</label>
            <input @bind="user.ContactNumber" placeholder="63XXXXXXXXXX" maxlength="12" />
            @if (!string.IsNullOrEmpty(contactNumberError))
            {
                <p class="error-text">@contactNumberError</p>
            }
        </div>

        <div class="info-column">
            <label>Birthdate:</label>
            <input type="date" @bind="user.Birthdate"
                   min="@minBirthdate.ToString("yyyy-MM-dd")"
                   max="@maxBirthdate.ToString("yyyy-MM-dd")" />

            <label>Email Address:</label>
            <input type="email" @bind="user.Email" placeholder="example@domain.com" />
            @if (!string.IsNullOrEmpty(emailError))
            {
                <p class="error-text">@emailError</p>
            }

            <label>Username:</label>
            <input @bind="user.Username" />

            <label>Password:</label>
            <div class="password-wrapper">
                <input type="password" @bind="user.Password" id="passwordInput" />
                <button type="button" class="toggle-password" onclick="togglePassword()">Show</button>
            </div>
            <div class="password-requirements">
                <p style="font-size: 12px; color: #666; margin-top: 5px;">
                    Password requirements:<br />
                    • 8+ minimum characters<br />
                    • Contains uppercase and lowercase letters<br />
                    • Contains numbers
                </p>
            </div>
            @if (!string.IsNullOrEmpty(passwordError))
            {
                <p class="error-text">@passwordError</p>
            }
        </div>
    </div>

    <button class="save-btn" @onclick="SignUpUser">SIGN UP</button>

    <p class="@(isError ? "error-message" : "success-message")">@message</p>
</div>

<style>
    .error-text {
        color: #d32f2f;
        font-size: 12px;
        margin-top: 5px;
        margin-bottom: 10px;
    }

    .error-message {
        color: #d32f2f;
        font-weight: bold;
    }

    .success-message {
        color: #388e3c;
        font-weight: bold;
    }

    .password-requirements {
        margin-top: 5px;
        margin-bottom: 10px;
    }
</style>

@code {
    private User user = new();
    private string message = "";
    private string fileError = "";
    private string contactNumberError = "";
    private string emailError = "";
    private string passwordError = "";
    private bool isLoading = false;
    private bool isError = false;
    private DateTime minBirthdate;
    private DateTime maxBirthdate;

    // Image handling
    private string? imageUrl;
    private IBrowserFile? selectedFile;
    private const long MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB

    protected override void OnInitialized()
    {
        // Calculate date range: from 100 years ago to today
        maxBirthdate = DateTime.Today;
        minBirthdate = maxBirthdate.AddYears(-100);

        // Set default birthdate to 30 years ago (common adult age)
        user.Birthdate = maxBirthdate.AddYears(-30);
    }

    private bool ValidateContactNumber()
    {
        contactNumberError = "";

        if (string.IsNullOrWhiteSpace(user.ContactNumber))
        {
            contactNumberError = "Contact number is required.";
            return false;
        }

        // Remove any spaces or dashes
        var cleanNumber = user.ContactNumber.Replace(" ", "").Replace("-", "");

        // Check if it contains only digits
        if (!Regex.IsMatch(cleanNumber, @"^\d+$"))
        {
            contactNumberError = "Contact number must contain only digits.";
            return false;
        }

        // Check if it starts with 63
        if (!cleanNumber.StartsWith("63"))
        {
            contactNumberError = "Contact number must start with 63 (Philippines country code).";
            return false;
        }

        // Check if length is exactly 12
        if (cleanNumber.Length != 12)
        {
            contactNumberError = "Contact number must be exactly 12 digits (including 63).";
            return false;
        }

        // Update the user object with cleaned number
        user.ContactNumber = cleanNumber;
        return true;
    }

    private bool ValidateEmail()
    {
        emailError = "";

        if (string.IsNullOrWhiteSpace(user.Email))
        {
            emailError = "Email address is required.";
            return false;
        }

        // Email validation pattern
        var emailPattern = @"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$";

        if (!Regex.IsMatch(user.Email, emailPattern))
        {
            emailError = "Please enter a valid email address (e.g., example@domain.com).";
            return false;
        }

        return true;
    }

    private bool ValidatePassword()
    {
        passwordError = "";

        if (string.IsNullOrWhiteSpace(user.Password))
        {
            passwordError = "Password is required.";
            return false;
        }

        // Check minimum length
        if (user.Password.Length < 8)
        {
            passwordError = "Password must be at least 8 characters long.";
            return false;
        }

        // Check for uppercase letter
        if (!Regex.IsMatch(user.Password, @"[A-Z]"))
        {
            passwordError = "Password must contain at least one uppercase letter.";
            return false;
        }

        // Check for lowercase letter
        if (!Regex.IsMatch(user.Password, @"[a-z]"))
        {
            passwordError = "Password must contain at least one lowercase letter.";
            return false;
        }

        // Check for number
        if (!Regex.IsMatch(user.Password, @"\d"))
        {
            passwordError = "Password must contain at least one number.";
            return false;
        }

        return true;
    }

    private async Task SignUpUser()
    {
        // Reset messages
        message = "";
        fileError = "";
        contactNumberError = "";
        emailError = "";
        passwordError = "";
        isError = false;
        isLoading = true;

        try
        {
            // Validate required fields
            if (string.IsNullOrWhiteSpace(user.FirstName) ||
                string.IsNullOrWhiteSpace(user.LastName) ||
                string.IsNullOrWhiteSpace(user.Gender) ||
                string.IsNullOrWhiteSpace(user.Username))
            {
                message = "Please fill all required fields.";
                isError = true;
                return;
            }

            // Validate contact number
            if (!ValidateContactNumber())
            {
                isError = true;
                return;
            }

            // Validate email
            if (!ValidateEmail())
            {
                isError = true;
                return;
            }

            // Validate password
            if (!ValidatePassword())
            {
                isError = true;
                return;
            }

            if (user.Birthdate < minBirthdate || user.Birthdate > maxBirthdate)
            {
                message = $"Please select a valid birthdate between {minBirthdate:MM/dd/yyyy} and {maxBirthdate:MM/dd/yyyy}.";
                isError = true;
                return;
            }

            // Handle image upload if a file was selected
            if (selectedFile != null)
            {
                await ProcessAndSaveImage();
            }

            await UserService.CreateUser(user);
            message = "User registered successfully!";
            isError = false;

            await Task.Delay(1000);
            Navigation.NavigateTo("/");
        }
        catch (Exception ex)
        {
            message = $"Error creating account: {ex.Message}";
            isError = true;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void NavigateToLogin()
    {
        Navigation.NavigateTo("/");
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        fileError = "";
        selectedFile = e.File;

        // Validate file type
        if (!selectedFile.ContentType.Contains("image/png") &&
            !selectedFile.ContentType.Contains("image/jpeg") &&
            !selectedFile.ContentType.Contains("image/jpg"))
        {
            fileError = "Please select a valid image file (PNG, JPEG, or JPG).";
            selectedFile = null;
            return;
        }

        // Check file size
        if (selectedFile.Size > MAX_FILE_SIZE)
        {
            fileError = "File size must be less than 5MB.";
            selectedFile = null;
            return;
        }

        try
        {
            // Convert to base64 for display preview
            var format = "image/png";
            var resizedImage = await selectedFile.RequestImageFileAsync(format, 200, 200);
            var buffer = new byte[resizedImage.Size];
            await resizedImage.OpenReadStream().ReadAsync(buffer);
            imageUrl = $"data:{format};base64,{Convert.ToBase64String(buffer)}";

            StateHasChanged();
        }
        catch (Exception ex)
        {
            fileError = $"Error processing image: {ex.Message}";
            selectedFile = null;
        }
    }

    private async Task ProcessAndSaveImage()
    {
        if (selectedFile == null) return;

        try
        {
            // Convert the image to base64 and store in user model
            var format = "image/png";
            var resizedImage = await selectedFile.RequestImageFileAsync(format, 400, 400);
            var buffer = new byte[resizedImage.Size];
            await resizedImage.OpenReadStream().ReadAsync(buffer);

            // Store base64 string in user model
            user.ProfileImageUrl = $"data:{format};base64,{Convert.ToBase64String(buffer)}";
        }
        catch (Exception ex)
        {
            throw new Exception($"Failed to process image: {ex.Message}");
        }
    }
}

<script>
    function togglePassword() {
        const input = document.getElementById('passwordInput');
        const button = event.target;
        if (input.type === 'password') {
            input.type = 'text';
            button.textContent = 'Hide';
        } else {
            input.type = 'password';
            button.textContent = 'Show';
        }
    }
</script>