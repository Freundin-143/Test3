@page "/ListTenants"
@using Test3.Data.Models
@using Test3.Data.Services
@inject LeaseService LeaseService
@inject ApartmentService ApartmentService
@inject RoomService RoomService
@inject UserService UserService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<div class="dashboard-layout">
    <!-- Sidebar (keep your existing sidebar) -->
    <aside class="sidebar">
        <div class="logo">
            <img src="images/Default_Landlord.png" alt="Logo">
            <h2>DASHBOARD</h2>
        </div>

        <nav>
            <button class="nav-btn manage-apartment" @onclick="ManageApartment">Manage Apartment</button>
            <button class="nav-btn list-tenants" @onclick="ListofTenants">List of Tenants</button>
            <button class="nav-btn transaction-history" @onclick="TransacHistory">Transaction History</button>
        </nav>

        <div class="bottom-section">
            <button class="logout-btn" @onclick="Logout">
                Log out
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header-section">
            <h2>Tenant Management</h2>
            <button class="btn-add-tenant" @onclick="ShowAddModal" disabled="@isLoading">
                + Add Tenant
            </button>
        </div>

        @if (isLoading && !ShowModal)
        {
            <div class="loading">Loading tenants...</div>
        }
        else if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="error-message">@errorMessage</div>
        }
        else
        {
            <div class="table-container">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th>Full Name</th>
                            <th>Apartment Name</th>
                            <th>Unit#</th>
                            <th>Contact #</th>
                            <th>Email</th>
                            <th>Move‑in Date</th>
                            <th>Move-out Date</th>
                            <th>Lease Duration</th>
                            <th>Monthly Rent</th>
                            <th>Security Deposit</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (!leases.Any())
                        {
                            <tr>
                                <td colspan="11" class="text-center no-data">No tenants found.</td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var lease in leases.Select((value, index) => new { value, index }))
                            {
                                <tr>
                                    <td>@(lease.index + 1)</td>
                                    <td>@lease.value.FullName</td>
                                    <td>@GetApartmentNameForUnit(lease.value.UnitNumber)</td>
                                    <td>@lease.value.UnitNumber</td>
                                    <td>@lease.value.Contact</td>
                                    <td>@lease.value.Email</td>
                                    <td>@lease.value.MoveInDate.ToString("MMM dd, yyyy")</td>
                                    <td>@GetFormattedMoveOutDate(lease.value.MoveOutDate)</td>
                                    <td>@lease.value.LeaseDuration</td>
                                    <td>₱@lease.value.RentAmount.ToString("N2")</td>
                                    <td>₱@lease.value.SecurityDeposit.ToString("N2")</td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>

    <!-- Add Tenant Modal -->
    <!-- Add Tenant Modal -->
    @if (ShowModal)
    {
        <div class="modal-overlay">
            <div class="modal-box">
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label class="required">Full Name</label>
                            @if (!registeredUsers.Any())
                            {
                                <div class="no-users-warning">
                                    No registered users found. Users need to sign up in the tenant portal first.
                                </div>
                            }
                            else
                            {
                                <div class="search-dropdown">
                                    <input type="text"
                                           class="form-control search-input"
                                           placeholder="Search tenant by name..."
                                           value="@userSearchTerm"
                                           @oninput="HandleSearchInput"
                                           @onfocus="() => showUserDropdown = true" />

                                    @if (showUserDropdown && filteredUsers.Any())
                                    {
                                        <div class="dropdown-list">
                                            @foreach (var user in filteredUsers)
                                            {
                                                <div class="dropdown-item" @onclick="() => SelectUser(user)">
                                                    <strong>@FormatUserName(user)</strong>
                                                    @if (!string.IsNullOrWhiteSpace(user.Email))
                                                    {
                                                        <small class="user-email">@user.Email</small>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                    else if (showUserDropdown && !string.IsNullOrWhiteSpace(userSearchTerm) && !filteredUsers.Any())
                                    {
                                        <div class="dropdown-list">
                                            <div class="dropdown-item no-results">No users found matching "@userSearchTerm"</div>
                                        </div>
                                    }
                                </div>
                            }
                            @if (validationErrors.ContainsKey("FullName"))
                            {
                                <div class="validation-error">@validationErrors["FullName"]</div>
                            }
                        </div>

                        <div class="form-group">
                            <label class="required">Unit Number</label>
                            @if (!availableUnits.Any())
                            {
                                <div class="no-units-warning">
                                    No available units found. Please add units in Manage Apartments first.
                                </div>
                            }
                            else
                            {
                                <select class="form-control" @bind="selectedUnitKey" @bind:after="OnUnitSelected">
                                    <option value="">Select Unit</option>
                                    @foreach (var unit in availableUnits)
                                    {
                                        <option value="@GetUnitKey(unit)">
                                            @unit.UnitNumber - @GetApartmentName(unit.ApartmentId)
                                        </option>
                                    }
                                </select>
                            }
                            @if (validationErrors.ContainsKey("UnitNumber"))
                            {
                                <div class="validation-error">@validationErrors["UnitNumber"]</div>
                            }
                        </div>

                        <div class="form-group">
                            <label class="required">Contact Number</label>
                            <input class="form-control" @bind="newLease.Contact"
                                   placeholder="e.g., +63 912 345 6789"
                                   disabled="@isUserSelected" />
                            @if (validationErrors.ContainsKey("Contact"))
                            {
                                <div class="validation-error">@validationErrors["Contact"]</div>
                            }
                        </div>

                        <div class="form-group">
                            <label>Email Address</label>
                            <input class="form-control" @bind="newLease.Email"
                                   placeholder="Enter email address" type="email"
                                   disabled="@isUserSelected" />
                            @if (validationErrors.ContainsKey("Email"))
                            {
                                <div class="validation-error">@validationErrors["Email"]</div>
                            }
                        </div>

                        <div class="form-group">
                            <label class="required">Move-in Date</label>
                            <input class="form-control" type="date" @bind="newLease.MoveInDate"
                                   max="@DateTime.Now.ToString("yyyy-MM-dd")" />
                            @if (validationErrors.ContainsKey("MoveInDate"))
                            {
                                <div class="validation-error">@validationErrors["MoveInDate"]</div>
                            }
                        </div>

                        <div class="form-group">
                            <label class="required">Lease Duration</label>
                            <select class="form-control" @bind="newLease.LeaseDuration">
                                <option value="">Select Duration</option>
                                <option value="6 months">6 months</option>
                                <option value="1 year">1 year</option>
                                <option value="2 years">2 years</option>
                                <option value="Month-to-month">Month-to-month</option>
                            </select>
                            @if (validationErrors.ContainsKey("LeaseDuration"))
                            {
                                <div class="validation-error">@validationErrors["LeaseDuration"]</div>
                            }
                        </div>

                        <div class="form-group">
                            <label class="required">Monthly Rent (₱)</label>
                            <input class="form-control" type="number" @bind="newLease.RentAmount"
                                   step="0.01" placeholder="0.00" readonly />
                            <small class="form-text">Automatically filled based on selected unit</small>
                            @if (validationErrors.ContainsKey("RentAmount"))
                            {
                                <div class="validation-error">@validationErrors["RentAmount"]</div>
                            }
                        </div>

                        <div class="form-group">
                            <label class="required">Security Deposit (₱)</label>
                            <input class="form-control" type="number" @bind="newLease.SecurityDeposit"
                                   step="0.01" placeholder="0.00" />
                            @if (validationErrors.ContainsKey("SecurityDeposit"))
                            {
                                <div class="validation-error">@validationErrors["SecurityDeposit"]</div>
                            }
                        </div>
                    </form>

                    @if (!string.IsNullOrEmpty(saveMessage))
                    {
                        <div class="save-message @(isSaveError ? "error" : "success")">
                            @saveMessage
                        </div>
                    }
                </div>

                <div class="modal-footer">
                    <button class="btn-secondary" @onclick="CloseModal" disabled="@isSaving">
                        Cancel
                    </button>
                    <button class="btn-primary" @onclick="SaveLease" disabled="@isSaving">
                        @if (isSaving)
                        {
                            <span>Saving...</span>
                        }
                        else
                        {
                            <span>Save Tenant</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    }
</div>


@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "landlordId")]
    public string? LandlordId { get; set; }

    private List<Lease> leases = new();
    private List<Room> availableUnits = new();
    private List<User> registeredUsers = new();
    private List<User> filteredUsers = new();
    private Lease newLease = new();
    private string selectedUserId = "";
    private string userSearchTerm = "";
    private bool showUserDropdown = false;
    private bool isUserSelected = false;
    private bool ShowModal = false;
    private bool isLoading = true;
    private bool isSaving = false;
    private string errorMessage = "";
    private string saveMessage = "";
    private bool isSaveError = false;
    private Dictionary<string, string> validationErrors = new();
    private Dictionary<string, string> apartmentNames = new();
    private string selectedUnitKey = "";

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrEmpty(LandlordId))
        {
            errorMessage = "Landlord ID not found. Please login again.";
            isLoading = false;
            return;
        }

        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        errorMessage = "";

        try
        {
            // Load existing leases
            leases = await LeaseService.GetLeasesByLandlordAsync(LandlordId);

            // Load available units (rooms that are not occupied)
            var allRooms = await RoomService.GetRoomsByLandlordIdAsync(LandlordId);
            var occupiedUnits = leases.Select(l => l.UnitNumber).ToList();
            availableUnits = allRooms.Where(r => !occupiedUnits.Contains(r.UnitNumber) && r.Status == "Available").ToList();

            // *** ADD THIS: Load apartment names ***
            await LoadApartmentNames();

            // Load unit to apartment mapping
            await LoadUnitApartmentMapping();

            // Load registered users from UserService
            registeredUsers = await UserService.GetAllUsersAsync();
            filteredUsers = registeredUsers;
        }
        catch (Exception ex)
        {
            errorMessage = "Error loading data. Please try again.";
            Console.WriteLine($"Error loading data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadApartmentNames()
    {
        try
        {
            var apartments = await ApartmentService.GetApartmentsByLandlordIdAsync(LandlordId);
            apartmentNames = apartments.ToDictionary(a => a.Id, a => a.ApartmentName);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading apartment names: {ex.Message}");
            apartmentNames = new Dictionary<string, string>();
        }
    }

    private string GetApartmentName(string apartmentId)
    {
        return apartmentNames.ContainsKey(apartmentId)
            ? apartmentNames[apartmentId]
            : "Unknown Apartment";
    }

    private string GetUnitKey(Room unit)
    {
        return $"{unit.ApartmentId}|{unit.UnitNumber}";
    }

    private string FormatUserName(User user)
    {
        // Format: First Name, Middle Name, Last Name
        var parts = new List<string>();

        if (!string.IsNullOrWhiteSpace(user.FirstName))
            parts.Add(user.FirstName);

        if (!string.IsNullOrWhiteSpace(user.MiddleName))
            parts.Add(user.MiddleName);

        if (!string.IsNullOrWhiteSpace(user.LastName))
            parts.Add(user.LastName);

        return string.Join(" ", parts);
    }

    private void HandleSearchInput(ChangeEventArgs e)
    {
        userSearchTerm = e.Value?.ToString() ?? "";
        FilterUsers();
    }

    private void FilterUsers()
    {
        if (string.IsNullOrWhiteSpace(userSearchTerm))
        {
            filteredUsers = registeredUsers;
        }
        else
        {
            var searchLower = userSearchTerm.ToLower();
            filteredUsers = registeredUsers.Where(u =>
                (u.FirstName?.ToLower().Contains(searchLower) ?? false) ||
                (u.MiddleName?.ToLower().Contains(searchLower) ?? false) ||
                (u.LastName?.ToLower().Contains(searchLower) ?? false) ||
                (u.Email?.ToLower().Contains(searchLower) ?? false)
            ).ToList();
        }
        StateHasChanged();
    }


    private void SelectUser(User user)
    {
        selectedUserId = user.Id;
        newLease.FullName = FormatUserName(user);
        newLease.Contact = user.ContactNumber ?? "";
        newLease.Email = user.Email ?? "";
        userSearchTerm = FormatUserName(user);
        isUserSelected = true;
        showUserDropdown = false;
        StateHasChanged();
    }

    private void ClearUserSelection()
    {
        selectedUserId = "";
        newLease.FullName = "";
        newLease.Contact = "";
        newLease.Email = "";
        userSearchTerm = "";
        isUserSelected = false;
        showUserDropdown = false;
        filteredUsers = registeredUsers;
        StateHasChanged();
    }

    private void OnUnitSelected()
    {
        if (!string.IsNullOrWhiteSpace(selectedUnitKey))
        {
            // Find the exact unit using the unique key
            var selectedUnit = availableUnits.FirstOrDefault(u => GetUnitKey(u) == selectedUnitKey);
            if (selectedUnit != null)
            {
                newLease.UnitNumber = selectedUnit.UnitNumber;
                newLease.RentAmount = selectedUnit.RoomPrice;
                StateHasChanged();
            }
        }
    }

    private async void ShowAddModal()
    {
        if (string.IsNullOrEmpty(LandlordId))
        {
            errorMessage = "Please login again.";
            return;
        }

        newLease = new Lease { LandlordId = LandlordId, MoveInDate = DateTime.Today };
        selectedUserId = "";
        userSearchTerm = "";
        isUserSelected = false;
        showUserDropdown = false;
        selectedUnitKey = "";
        validationErrors.Clear();
        saveMessage = "";
        isSaveError = false;

        // Refresh available units and users
        await LoadAvailableUnits();
        await LoadRegisteredUsers();

        ShowModal = true;
        StateHasChanged();
    }

    private async Task LoadAvailableUnits()
    {
        try
        {
            var allRooms = await RoomService.GetRoomsByLandlordIdAsync(LandlordId);
            var occupiedUnits = leases.Select(l => l.UnitNumber).ToList();
            availableUnits = allRooms.Where(r => !occupiedUnits.Contains(r.UnitNumber) && r.Status == "Available").ToList();

            // *** ADD THIS: Refresh apartment names when loading units ***
            await LoadApartmentNames();

            // Load unit to apartment mapping
            await LoadUnitApartmentMapping();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading available units: {ex.Message}");
        }
    }

    private async Task LoadRegisteredUsers()
    {
        try
        {
            registeredUsers = await UserService.GetAllUsersAsync();
            filteredUsers = registeredUsers;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading registered users: {ex.Message}");
            registeredUsers = new List<User>();
            filteredUsers = new List<User>();
        }
    }

    private void CloseModal()
    {
        ShowModal = false;
        validationErrors.Clear();
        saveMessage = "";
        isSaveError = false;
        selectedUserId = "";
        userSearchTerm = "";
        isUserSelected = false;
        showUserDropdown = false;
        selectedUnitKey = "";
        StateHasChanged();
    }

    private bool ValidateForm()
    {
        validationErrors.Clear();

        if (string.IsNullOrWhiteSpace(newLease.FullName))
            validationErrors["FullName"] = "Please select a tenant from the list.";

        if (string.IsNullOrWhiteSpace(newLease.UnitNumber))
            validationErrors["UnitNumber"] = "Unit number is required.";

        if (string.IsNullOrWhiteSpace(newLease.Contact))
            validationErrors["Contact"] = "Contact number is required.";
        else if (newLease.Contact.Length < 10)
            validationErrors["Contact"] = "Contact number appears to be invalid.";

        if (string.IsNullOrWhiteSpace(newLease.LeaseDuration))
            validationErrors["LeaseDuration"] = "Lease duration is required.";

        if (newLease.RentAmount <= 0)
            validationErrors["RentAmount"] = "Monthly rent must be greater than 0.";

        if (newLease.SecurityDeposit < 0)
            validationErrors["SecurityDeposit"] = "Security deposit cannot be negative.";

        if (newLease.MoveInDate > DateTime.Today)
            validationErrors["MoveInDate"] = "Move-in date cannot be in the future.";

        return !validationErrors.Any();
    }

    private async Task SaveLease()
    {
        if (!ValidateForm())
        {
            StateHasChanged();
            return;
        }

        isSaving = true;
        saveMessage = "";
        isSaveError = false;
        StateHasChanged();

        try
        {
            // Check if unit is already occupied
            var isOccupied = await LeaseService.IsUnitOccupiedAsync(LandlordId, newLease.UnitNumber);
            if (isOccupied)
            {
                saveMessage = $"Unit {newLease.UnitNumber} is already occupied. Please select a different unit.";
                isSaveError = true;
                isSaving = false;
                StateHasChanged();
                return;
            }

            // Check if user is already assigned to another unit
            var existingUserLease = leases.FirstOrDefault(l => l.FullName == newLease.FullName && l.IsActive);
            if (existingUserLease != null)
            {
                saveMessage = $"{newLease.FullName} is already assigned to unit {existingUserLease.UnitNumber}.";
                isSaveError = true;
                isSaving = false;
                StateHasChanged();
                return;
            }

            // Save to database
            await LeaseService.CreateLeaseAsync(newLease);

            // Update room status to Occupied
            var rooms = await RoomService.GetRoomsByLandlordIdAsync(LandlordId);
            var roomToUpdate = rooms.FirstOrDefault(r => r.UnitNumber == newLease.UnitNumber);
            if (roomToUpdate != null)
            {
                roomToUpdate.Status = "Occupied";
                await RoomService.UpdateRoomAsync(roomToUpdate.Id, roomToUpdate);
            }

            saveMessage = "Tenant added successfully!";
            isSaveError = false;

            // Refresh data and close modal
            await LoadData();
            await Task.Delay(1500);
            CloseModal();
        }
        catch (Exception ex)
        {
            saveMessage = "Error saving tenant. Please try again.";
            isSaveError = true;
            Console.WriteLine($"Error saving lease: {ex.Message}");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    // Navigation methods
    private void Logout()
    {
        Navigation.NavigateTo("/Landlord", true);
    }

    private void ManageApartment()
    {
        Navigation.NavigateTo($"/ManageApartment?landlordId={LandlordId}", true);
    }

    private void ListofTenants()
    {
        Navigation.NavigateTo($"/ListTenants?landlordId={LandlordId}", true);
    }

    private void TransacHistory()
    {
        Navigation.NavigateTo($"/TransacHis?landlordId={LandlordId}", true);
    }
}
    // Dictionary for unit to apartment mapping
    private Dictionary<string, string> unitToApartmentMap = new();

    private async Task LoadUnitApartmentMapping()
    {
        try
        {
            var rooms = await RoomService.GetRoomsByLandlordIdAsync(LandlordId);
            var apartments = await ApartmentService.GetApartmentsByLandlordIdAsync(LandlordId);
            var apartmentDict = apartments.ToDictionary(a => a.Id, a => a.ApartmentName);

            unitToApartmentMap = rooms.ToDictionary(r => r.UnitNumber, r =>
                apartmentDict.ContainsKey(r.ApartmentId) ? apartmentDict[r.ApartmentId] : "Unknown Apartment");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading unit-apartment mapping: {ex.Message}");
            unitToApartmentMap = new Dictionary<string, string>();
        }
    }

    private string GetApartmentNameForUnit(string unitNumber)
    {
        return unitToApartmentMap.ContainsKey(unitNumber)
            ? unitToApartmentMap[unitNumber]
            : "Unknown Apartment";
    }

    private DateTime? CalculateMoveOutDate(DateTime moveInDate, string leaseDuration)
    {
        return leaseDuration.ToLower() switch
        {
            "6 months" => moveInDate.AddMonths(6),
            "1 year" => moveInDate.AddYears(1),
            "2 years" => moveInDate.AddYears(2),
            "month-to-month" => null, // Active tenants
            _ => null
        };
    }

    private string GetFormattedMoveOutDate(DateTime? moveOutDate)
    {
        return moveOutDate?.ToString("MMM dd, yyyy") ?? "-";
    }
