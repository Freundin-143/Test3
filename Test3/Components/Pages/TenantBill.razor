@page "/payments/{UserId}"
@using Test3.Data.Models
@using Test3.Data.Services
@inject LeaseService LeaseService
@inject UtilityBillService UtilityBillService
@inject TransactionService TransactionService
@inject RoomService RoomService
@inject UserService UserService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Tenant Payment Portal</PageTitle>

<div class="container">
    @if (isLoading)
    {
        <div class="loading">Loading bill information...</div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-message">@errorMessage</div>
        <button class="back_btn" @onclick="BackBtn">Back to Dashboard</button>
    }
    else if (currentLease == null)
    {
        <div class="no-lease-message">
            <button class="back_btn" @onclick="BackBtn">Back to Dashboard</button> 
            <h3>No Active Lease Found</h3>
            <p>You don't have an active lease agreement. Please contact your landlord.</p>
        </div>
    }
    else
    {
        <div class="header-section">
            <div class="header-title-row">
                <button class="back_btn" @onclick="BackBtn">Back to Dashboard</button>
                <h2>BILL FOR @DateTime.Now.ToString("MMMM yyyy").ToUpper()</h2>
            </div>
            <div class="tenant-info">
                <p><strong>Tenant:</strong> @currentLease.FullName</p>
                <p><strong>Unit:</strong> @currentLease.UnitNumber</p>
                @if (hasPaidCurrentBill)
                {
                    <div class="payment-status-badge">
                        <span class="status-completed">PAID</span>
                    </div>
                }
            </div>
            <div class="info-grid">
                <div class="info-row">
                    <label>Room Price:</label>
                    <span class="amount">₱@RoomPrice.ToString("N2")</span>
                </div>
                <div class="info-row">
                    <label>Water Bill:</label>
                    <span class="amount">₱@WaterBill.ToString("N2")</span>
                </div>
                <div class="info-row">
                    <label>Electricity Bill:</label>
                    <span class="amount">₱@ElectricityBill.ToString("N2")</span>
                </div>
                <div class="info-row right-column">
                    <label>Due Date:</label>
                    <span class="date">@DueDate.ToString("MMM dd, yyyy")</span>
                </div>
                <div class="info-row right-column total-row">
                    <label>Total Amount Due:</label>
                    <span class="total-amount">₱@TotalAmount.ToString("N2")</span>
                </div>
            </div>
        </div>

        <div class="payment-section">
            <h2>PAYMENT STATUS</h2>

            @if (hasPaidCurrentBill)
            {
                <div class="payment-completed">
                    <div class="completed-icon">✓</div>
                    <h3>Payment Completed</h3>
                    <p>Your payment of <strong>₱@TotalAmount.ToString("N2")</strong> for @DateTime.Now.ToString("MMMM yyyy") has been successfully processed.</p>
                    <div class="payment-details">
                        <p><strong>Paid on:</strong> @GetCurrentMonthPaymentDate()</p>
                        <p><strong>Payment Method:</strong> @GetCurrentMonthPaymentMethod()</p>
                    </div>
                </div>
            }
            else
            {
                <div class="payment-instruction">
                    <p><strong>Please pay the exact total amount: ₱@TotalAmount.ToString("N2")</strong></p>
                </div>
                <div class="payment-form">
                    <div class="form-group">
                        <label>Payment Amount (₱):</label>
                        <input type="number" @bind="PaymentAmount" step="0.01"
                               placeholder="Enter total amount" class="payment-input" />
                        @if (showAmountError)
                        {
                            <div class="validation-error">@amountErrorText</div>
                        }
                    </div>
                    <div class="form-group">
                        <label>Payment Method:</label>
                        <select @bind="PaymentMethod" class="payment-method-select">
                            <option value="">Select method...</option>
                            <option value="GCASH">GCash</option>
                            <option value="CASH">Cash</option>
                            <option value="DEBIT CARD">Debit Card</option>
                            <option value="CREDIT CARD">Credit Card</option>
                            <option value="BANK TRANSFER">Bank Transfer</option>
                        </select>
                        @if (showMethodError)
                        {
                            <div class="validation-error">Please select a payment method</div>
                        }
                    </div>
                </div>
                <button class="submit-btn" @onclick="SubmitPayment" disabled="@isProcessingPayment">
                    @(isProcessingPayment ? "Processing..." : "Submit Payment")
                </button>
            }

            @if (!string.IsNullOrEmpty(paymentMessage))
            {
                <div class="payment-message @(isPaymentError ? "error" : "success")">
                    @paymentMessage
                </div>
            }
        </div>

        <div class="history-section">
            <h2>PAYMENT HISTORY</h2>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Method</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    @if (PaymentHistory.Any())
                    {
                        @foreach (var payment in PaymentHistory)
                        {
                            <tr class="@(IsCurrentMonthPayment(payment) ? "current-month-payment" : "")">
                                <td>@payment.PaymentDate.ToString("MM/dd/yyyy")</td>
                                <td>₱@payment.PaymentAmount.ToString("N2")</td>
                                <td>@payment.PaymentMethod</td>
                                <td>
                                    <span class="status-badge @payment.Status.ToLower()">
                                        @(IsCurrentMonthPayment(payment) ? "CURRENT" : payment.Status)
                                    </span>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="5" class="no-payments">No payment history found</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    [Parameter]
    public string UserId { get; set; } = string.Empty;

    private decimal RoomPrice { get; set; }
    private decimal WaterBill { get; set; }
    private decimal ElectricityBill { get; set; }
    private DateTime DueDate { get; set; }
    private decimal TotalAmount => RoomPrice + WaterBill + ElectricityBill;

    private decimal PaymentAmount { get; set; }
    private string PaymentMethod { get; set; } = "";
    private bool showAmountError = false;
    private bool showMethodError = false;
    private string amountErrorText = "";
    private bool isProcessingPayment = false;
    private string paymentMessage = "";
    private bool isPaymentError = false;
    private bool hasPaidCurrentBill = false;

    private List<TransactionHistory> PaymentHistory { get; set; } = new();
    private bool isLoading = true;
    private string errorMessage = "";

    private Lease? currentLease;
    private Room? currentRoom;
    private User? currentUser;
    private UtilityBill? currentUtilityBill;
    private TransactionHistory? currentMonthTransaction;

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrEmpty(UserId))
        {
            errorMessage = "User ID not found.";
            isLoading = false;
            return;
        }

        await LoadUserData();
    }

    private async Task LoadUserData()
    {
        try
        {
            // Get user info
            currentUser = await UserService.GetUserByIdAsync(UserId);
            if (currentUser == null)
            {
                errorMessage = "User not found.";
                isLoading = false;
                return;
            }

            // Get all leases and find matching one
            var allLeases = await LeaseService.GetAllLeasesAsync();
            currentLease = FindUserLease(allLeases, currentUser);

            if (currentLease == null)
            {
                errorMessage = "No active lease found for this user. Please contact your landlord.";
                isLoading = false;
                return;
            }

            // Get room info
            var rooms = await RoomService.GetRoomsByLandlordIdAsync(currentLease.LandlordId);
            currentRoom = rooms.FirstOrDefault(r => r.UnitNumber == currentLease.UnitNumber);

            if (currentRoom == null)
            {
                errorMessage = "Room information not found.";
                isLoading = false;
                return;
            }

            RoomPrice = currentRoom.RoomPrice;

            // Get current utility bills
            var currentDate = DateTime.UtcNow;
            currentUtilityBill = await UtilityBillService.GetBillByUnitNumberAsync(
                currentLease.UnitNumber, currentDate.Month, currentDate.Year);

            if (currentUtilityBill != null)
            {
                ElectricityBill = currentUtilityBill.ElectricityBill;
                WaterBill = currentUtilityBill.WaterBill;
                DueDate = currentUtilityBill.DueDate;
            }
            else
            {
                ElectricityBill = 0;
                WaterBill = 0;
                DueDate = new DateTime(currentDate.Year, currentDate.Month, 1).AddMonths(1);
            }

            // Load payment history and check if current month is already paid
            PaymentHistory = await TransactionService.GetTransactionsByUserAsync(UserId);
            hasPaidCurrentBill = await CheckIfCurrentMonthPaid();

            if (hasPaidCurrentBill)
            {
                currentMonthTransaction = GetCurrentMonthTransaction();
            }

            isLoading = false;
        }
        catch (Exception ex)
        {
            errorMessage = "Error loading user data. Please try again.";
            isLoading = false;
            Console.WriteLine($"Error loading user data: {ex.Message}");
        }
    }

    private async Task<bool> CheckIfCurrentMonthPaid()
    {
        var currentDate = DateTime.UtcNow;
        return PaymentHistory.Any(p =>
            p.PaymentDate.Month == currentDate.Month &&
            p.PaymentDate.Year == currentDate.Year);
    }

    private TransactionHistory? GetCurrentMonthTransaction()
    {
        var currentDate = DateTime.UtcNow;
        return PaymentHistory.FirstOrDefault(p =>
            p.PaymentDate.Month == currentDate.Month &&
            p.PaymentDate.Year == currentDate.Year);
    }

    private bool IsCurrentMonthPayment(TransactionHistory payment)
    {
        var currentDate = DateTime.UtcNow;
        return payment.PaymentDate.Month == currentDate.Month &&
               payment.PaymentDate.Year == currentDate.Year;
    }

    private string GetCurrentMonthPaymentDate()
    {
        return currentMonthTransaction?.PaymentDate.ToString("MMM dd, yyyy") ?? DateTime.Now.ToString("MMM dd, yyyy");
    }

    private string GetCurrentMonthPaymentMethod()
    {
        return currentMonthTransaction?.PaymentMethod ?? "Unknown";
    }

    private Lease? FindUserLease(List<Lease> leases, User user)
    {
        var userFullName = $"{user.FirstName} {user.LastName}".Trim().ToLower();
        var userFullNameWithMiddle = $"{user.FirstName} {user.MiddleName} {user.LastName}".Trim().ToLower();

        return leases.FirstOrDefault(lease =>
            lease.FullName.Trim().ToLower() == userFullName ||
            lease.FullName.Trim().ToLower() == userFullNameWithMiddle ||
            lease.FullName.Trim().ToLower().Contains(user.FirstName.ToLower()) ||
            lease.FullName.Trim().ToLower().Contains(user.LastName.ToLower()));
    }

    private async Task SubmitPayment()
    {
        showAmountError = false;
        showMethodError = false;
        amountErrorText = "";
        paymentMessage = "";
        isPaymentError = false;

        // Validation
        if (string.IsNullOrEmpty(PaymentMethod))
        {
            showMethodError = true;
            return;
        }

        if (PaymentAmount != TotalAmount)
        {
            showAmountError = true;
            amountErrorText = $"Please pay the exact total amount of ₱{TotalAmount.ToString("N2")}";
            return;
        }

        if (PaymentAmount <= 0)
        {
            showAmountError = true;
            amountErrorText = "Payment amount must be greater than 0";
            return;
        }

        // Check if already paid for current month
        if (hasPaidCurrentBill)
        {
            paymentMessage = "You have already paid for this month.";
            isPaymentError = true;
            return;
        }

        isProcessingPayment = true;
        StateHasChanged();

        try
        {
            var currentDate = DateTime.UtcNow;
            var transaction = new TransactionHistory
            {
                UserId = UserId,
                FullName = currentLease?.FullName ?? "",
                UnitNumber = currentLease?.UnitNumber ?? "",
                LandlordId = currentLease?.LandlordId ?? "",
                PaymentAmount = PaymentAmount,
                PaymentMethod = PaymentMethod,
                PaymentDate = currentDate,
                Status = "COMPLETED",
                RoomPrice = RoomPrice,
                ElectricityBill = ElectricityBill,
                WaterBill = WaterBill,
                TotalAmount = TotalAmount
            };

            // Save transaction
            await TransactionService.CreateTransactionAsync(transaction);

            // Mark utility bill as paid (but don't remove it)
            if (currentUtilityBill != null)
            {
                currentUtilityBill.IsPaid = true;
                await UtilityBillService.CreateOrUpdateBillAsync(currentUtilityBill);
            }

            paymentMessage = "Payment submitted successfully!";
            isPaymentError = false;

            // Refresh data to show completed state
            await LoadUserData();

            // Reset form
            PaymentAmount = 0;
            PaymentMethod = "";

            // Clear success message after delay
            await Task.Delay(3000);
            paymentMessage = "";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            paymentMessage = "Error processing payment. Please try again.";
            isPaymentError = true;
            Console.WriteLine($"Error processing payment: {ex.Message}");
        }
        finally
        {
            isProcessingPayment = false;
            StateHasChanged();
        }
    }

    private void BackBtn()
    {
        Navigation.NavigateTo($"/dashboard/{UserId}");
    }
}